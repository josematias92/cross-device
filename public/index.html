<!DOCTYPE html>
<html>
<head>
  <title>Passkey Demo</title>
</head>
<body>
  <input id="username" placeholder="Username" />
  <button id="registerBtn">Register</button>
  <button id="authBtn">Authenticate</button>
  <script type="module">
    import simplewebauthnbrowser from 'https://cdn.jsdelivr.net/npm/@simplewebauthn/browser@13.1.0/+esm'
  </script>
  <script type="module">
    // Optional: Use @simplewebauthn/browser (uncomment if installed)
    import { startRegistration, startAuthentication } from 'simplewebauthnbrowser';

    // Base64url to ArrayBuffer
    function base64urlToArrayBuffer(base64url) {
      let str = base64url.replace(/-/g, '+').replace(/_/g, '/');
      const padding = str.length % 4;
      if (padding) str += '='.repeat(4 - padding);
      const binary = window.atob(str);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
      return bytes.buffer;
    }

    // ArrayBuffer to Base64url
    function arrayBufferToBase64url(buffer) {
      const bytes = new Uint8Array(buffer);
      let binary = '';
      for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
      return window.btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    }

    // Register a passkey
    async function register() {
      const username = document.getElementById('username').value;
      if (!username) return alert('Enter a username');

      try {
        // Get registration options
        const resp = await fetch('http://localhost:4000/register/options', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username }),
        });
        const options = await resp.json();

        // Convert base64url to ArrayBuffer
        options.challenge = base64urlToArrayBuffer(options.challenge);
        options.user.id = base64urlToArrayBuffer(options.user.id);

        // Create credential (without @simplewebauthn/browser)
        const credential = await navigator.credentials.create({ publicKey: options });

        // Prepare response
        const credentialResponse = {
          id: credential.id,
          rawId: arrayBufferToBase64url(credential.rawId),
          type: credential.type,
          response: {
            clientDataJSON: arrayBufferToBase64url(credential.response.clientDataJSON),
            attestationObject: arrayBufferToBase64url(credential.response.attestationObject),
          },
        };

        // Verify with server
        const verifyResp = await fetch('http://localhost:4000/register/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, credential: credentialResponse }),
        });
        const result = await verifyResp.json();

        if (result.verified) {
          alert('Registration successful!');
        } else {
          alert('Registration failed: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Registration error:', error);
        alert('Registration failed: ' + error.message);
      }
    }

    // Authenticate with passkey
    async function authenticate() {
      const username = document.getElementById('username').value;
      if (!username) return alert('Enter a username');

      try {
        // Get authentication options
        const resp = await fetch('http://localhost:4000/auth/options', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username }),
        });
        const options = await resp.json();

        // Convert base64url to ArrayBuffer
        options.challenge = base64urlToArrayBuffer(options.challenge);
        options.allowCredentials = options.allowCredentials.map(cred => ({
          ...cred,
          id: base64urlToArrayBuffer(cred.id),
        }));

        // Authenticate
        const credential = await navigator.credentials.get({ publicKey: options });

        // Prepare response
        const credentialResponse = {
          id: credential.id,
          rawId: arrayBufferToBase64url(credential.rawId),
          type: credential.type,
          response: {
            clientDataJSON: arrayBufferToBase64url(credential.response.clientDataJSON),
            authenticatorData: arrayBufferToBase64url(credential.response.authenticatorData),
            signature: arrayBufferToBase64url(credential.response.signature),
            userHandle: credential.response.userHandle
              ? arrayBufferToBase64url(credential.response.userHandle)
              : null,
          },
        };

        // Verify with server
        const verifyResp = await fetch('http://localhost:4000/auth/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, credential: credentialResponse }),
        });
        const result = await verifyResp.json();

        if (result.verified) {
          alert('Authentication successful!');
        } else {
          alert('Authentication failed: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Authentication error:', error);
        alert('Authentication failed: ' + error.message);
      }
    }

    // Event listeners
    document.getElementById('registerBtn').addEventListener('click', register);
    document.getElementById('authBtn').addEventListener('click', authenticate);
  </script>
</body>
</html>
